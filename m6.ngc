(Pocket Table)
o<m6> sub
(DEBUG, Current tool: #<_current_tool>)
  (skip if tool already selected)
  o090 if [ #<_selected_tool> EQ #<_current_tool> ]
    o<m6> return
  o090 endif
(Manual tool change)
  o<mtc> if [ #40 EQ 1 ]
	G53 G0 Z11.5
	(DEBUG, Insert tool #<_selected_tool> )
	M0
	M61 Q#<_selected_tool>	
	G43
	o<m6> return
  o<mtc> endif
  (Turn off digital outputs)
  M65 P0
  M65 P1
  M65 P2

  (Tool Pocket Offsets)
  #51 = 0
  #52 = 30
  #53 = 60
  #54 = 90
  #55 = 120
  #56 = 150
  #57 = 180
  #58 = 210
  #59 = 240
  #60 = 270
  #61 = 300
  #62 = 330

  #<toolToPickupPos> = #[#<_selected_tool>+50]
  #<ZClearHeight>	= 11.75
  #<ZPickHeight>	= 8.32
  M66 P3 L0
  (DEBUG, Spindle sensor: #5399)
  o<spindlecheck> if [#5399 EQ 1 AND #<_current_tool> EQ 0]
    (MSG, ERROR Unexpected tool in spindle)
    o<m6> return
  o<spindlecheck> endif
  o100 if [ #<_current_tool> GT 0 ]
    #<toolToReturnPos> = #[#<_current_tool>+50]
    G53 G0 Z#<ZPickHeight>	(Retract to safe Z)
    G53 B#<toolToReturnPos> 
    M64 P1				(Extend ATC)
    M66 P0 L4 Q15			(Wait for ATC to extend, up to 15s)
    (Halt program if arm did not reach position)
    o101 if [ #5399 LT 0 ]
      M2
    o101 endif
    M64 P0				(Release tool)
    G4 P1.5
  (Wait for drawbar switch)
    G53 G0 Z#<ZClearHeight>
    #<toolToReturnPos> = 0
    M61 Q0
  o100 else
    G53 G0 Z#<ZClearHeight>
  (Check for tool in drawbar)
    M64 P0				(Release tool)
    M64 P1				(Extend ATC)
    M66 P0 L4 Q15			(Wait for ATC to extend, up to 15s)
    (Halt program if arm did not reach position)
    o102 if [ #5399 LT 0 ]
      M2
    o102 endif
  o100 endif
  o110 if [#<_selected_tool> GT 0 ]
    #<atc_dir> = 1
    o120 if [ #<_selected_tool> LE #<_current_tool> ]
      #<atc_dir> = -1
    o120 endif
    G53 G0 B[ #<toolToPickupPos> * #<atc_dir> ]
    G53 G1 Z8.1873 F30
    M65 P0
    G4 P2
    G53 G0 Z8.32
  o110 else
    G53 G0 Z#<ZClearHeight>
  o110 endif
  M65 P1			(End extend)
  M64 P2			(Retract ATC)
  M66 P1 L4 Q15		(Wait for retract)
  M65 P2			(End retract)
  M61 Q#<_selected_tool>	(Set active tool number)
  G43 (Update tool length offset)
o<m6> endsub

